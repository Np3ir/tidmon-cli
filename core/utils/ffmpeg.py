"""
FFmpeg utilities de tiddl
Código extraído de tiddl/core/utils/ffmpeg.py
"""

import subprocess
from pathlib import Path


def run(cmd: list[str]):
    """Run process without printing to terminal"""
    subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)


def is_ffmpeg_installed() -> bool:
    """Checks if `ffmpeg` is installed."""
    try:
        run(["ffmpeg", "-version"])
        return True
    except FileNotFoundError:
        return False


def convert_to_mp4(source: Path) -> Path:
    """Convert .ts to .mp4"""
    output_path = source.with_suffix(".mp4")
    
    run(["ffmpeg", "-y", "-i", str(source), "-c", "copy", str(output_path)])
    
    source.unlink()
    
    return output_path


def extract_flac(source: Path) -> Path:
    """
    Extrae FLAC audio de contenedor MP4
    Para HI_RES_LOSSLESS
    """
    
    tmp = source.with_suffix(".tmp.flac")
    dest = source.with_suffix(".flac")
    
    run(["ffmpeg", "-y", "-i", str(source), "-c", "copy", str(tmp)])
    
    tmp.replace(dest)
    
    # Eliminar source si es diferente
    if source != dest:
        try:
            source.unlink()
        except OSError:
            pass
    
    return dest


def fix_mp4_faststart(source: Path) -> Path:
    """
    Remux MP4/M4A para mover 'moov' atom al inicio
    Arregla archivos corruptos/fragmentados
    """
    tmp = source.with_name(source.stem + ".fixed" + source.suffix)
    
    run(["ffmpeg", "-y", "-i", str(source), "-c", "copy", "-movflags", "+faststart", str(tmp)])
    
    # Reemplazar original si tmp fue creado
    if tmp.exists():
        tmp.replace(source)
    
    return source
